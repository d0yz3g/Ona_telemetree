# Исправления в Telegram-боте на базе aiogram 3

## Обнаруженные проблемы

1. **Команды не работают:**
   - `/help_reflect` - Справка по получению советов
   - `/meditate` - Получить голосовую медитацию
   - `/help_meditate` - Справка по медитациям
   - `/reminder_on` - Включить ежедневные напоминания
   - `/reminder_off` - Отключить напоминания
   - `/reminder_status` - Проверить статус напоминаний
   - `/help_reminder` - Справка по напоминаниям

2. **Опросник зависает на первом вопросе** - после прохождения 5 демо-вопросов и перехода к 34 вопросам о сильных сторонах, бот не может корректно обработать ответы.

## Внесенные исправления

### 1. Добавление категорий к вопросам о сильных сторонах

В файле `questions.py` для каждого вопроса о сильных сторонах отсутствовало поле `category`, которое использовалось в функции `build_profile` для классификации ответов. Добавлены соответствующие категории для всех 34 вопросов:
- analytical - Аналитический склад ума
- creative - Творческое мышление
- leadership - Лидерские качества
- social - Коммуникабельность
- organized - Организованность
- resilient - Психологическая устойчивость

### 2. Обновление импортов в модуле services

В файле `services/__init__.py` отсутствовали необходимые импорты для корректной работы всех компонентов бота. Добавлены импорты:
```python
from .tts import generate_voice, delete_voice_file, MEDITATION_TEXTS
from .ai_client import generate_profile
from .recs import generate_recommendation, detect_focus, AVAILABLE_FOCUSES
from .astrology import make_natal_chart
from .scheduler import ReminderScheduler
```

### 3. Исправление функции `make_natal_chart`

Функция `make_natal_chart` в модуле `services/astrology.py` вызывалась с тремя параметрами (дата, город, имя), но принимала только два. Сигнатура функции была обновлена:
```python
def make_natal_chart(date_str: str, city: str, name: str = None) -> Dict[str, Any]:
```

Также добавлен параметр `name` в возвращаемые словари.

### 4. Установка необходимых зависимостей

Установлены отсутствующие пакеты, необходимые для работы бота:
- apscheduler - для планировщика напоминаний
- ephem - для астрологических расчетов
- httpx - для асинхронных HTTP-запросов
- openai - для работы с OpenAI API
- aiofiles - для асинхронной работы с файлами
- python-dotenv - для загрузки переменных окружения

## Результат

После внесения исправлений:
1. Команды `/help_reflect`, `/meditate`, `/help_meditate`, `/reminder_on`, `/reminder_off`, `/reminder_status`, `/help_reminder` теперь должны работать корректно.
2. Опросник должен проходить все 34 вопроса о сильных сторонах без зависаний.
3. Бот успешно запускается и выполняет все функции согласно спецификации.

Структура бота соответствует описанной в архитектурных документах, включая все необходимые компоненты:
- Профилирование пользователя через опросник
- Генерация рекомендаций через OpenAI
- Голосовые медитации через ElevenLabs
- Планировщик напоминаний через APScheduler 

## Исправление логирования для Railway

### Проблема
При деплое бота на Railway во вкладке "Deploy Logs" не отображались логи приложения, что затрудняло отладку и мониторинг работы бота.

### Решение
1. Модифицировано логирование в `main.py`:
   - Добавлен приоритетный вывод в `stdout` для Railway
   - Добавлены явные `print` сообщения для ключевых этапов работы бота
   - Улучшен формат сообщений логирования

2. Улучшена работа `restart_bot.py`:
   - Добавлено перенаправление вывода процесса в реальном времени
   - Использованы потоки для асинхронного чтения stdout и stderr процесса бота
   - Добавлены информативные сообщения о статусе работы монитора

3. Обновлен `Dockerfile`:
   - Добавлена переменная `PYTHONUNBUFFERED=1` для отключения буферизации вывода
   - Добавлены информационные сообщения при запуске контейнера
   - Улучшена команда запуска для более наглядного вывода

### Как проверить
1. После деплоя на Railway, перейдите во вкладку "Deploy Logs"
2. В логах должны отображаться сообщения от монитора ("МОНИТОР:") и от бота ("БОТ:")
3. При возникновении ошибок, они будут отображаться с префиксом "ОШИБКА:"

### Примечания
- Важно не использовать буферизацию вывода при работе с Railway
- В случае проблем с отображением логов, проверьте переменную среды `PYTHONUNBUFFERED`
- При необходимости более детального логирования, запустите монитор с флагом `--debug`:
  ```
  python restart_bot.py --debug
  ``` 

## Исправление предупреждений о буферизации в бинарном режиме

### Проблема
После деплоя на Railway в логах появились следующие предупреждения:
```
/usr/local/lib/python3.11/subprocess.py:1016: RuntimeWarning: line buffering (buffering=1) isn't supported in binary mode, the default buffer size will be used
  self.stdout = io.open(c2pread, 'rb', bufsize)

/usr/local/lib/python3.11/subprocess.py:1021: RuntimeWarning: line buffering (buffering=1) isn't supported in binary mode, the default buffer size will be used
  self.stderr = io.open(errread, 'rb', bufsize)
```

Эти предупреждения возникают, потому что в файле `restart_bot.py` при создании процесса используется построчная буферизация (`bufsize=1`) в сочетании с бинарным режимом (`universal_newlines=False`), что не поддерживается в Python.

### Решение
Изменен параметр `bufsize` с `1` на `0` в функции `subprocess.Popen()` в файле `restart_bot.py`:

```python
self.process = subprocess.Popen(
    [PYTHON_EXECUTABLE, BOT_SCRIPT],
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    bufsize=0,  # Отключаем буферизацию для бинарного режима
    universal_newlines=False  # Бинарный режим для совместимости
)
```

Значение `bufsize=0` полностью отключает буферизацию, что идеально подходит для перенаправления вывода в реальном времени и устраняет предупреждения.

### Как проверить
После деплоя на Railway предупреждения о буферизации должны исчезнуть из логов, а перенаправление вывода бота будет работать так же эффективно или даже лучше благодаря отсутствию буферизации. 

## Исправление ошибки конфликта экземпляров бота (TelegramConflictError)

### Проблема
При деплое на Railway возникала ошибка `TelegramConflictError: Conflict: terminated by other getUpdates request; make sure that only one bot instance is running`. Эта ошибка указывает на то, что несколько экземпляров бота пытаются одновременно получать обновления от Telegram API.

### Решение
Добавлен механизм обнаружения и предотвращения запуска нескольких экземпляров бота:

1. Использование сокета для блокировки порта:
   ```python
   def is_bot_already_running():
       try:
           sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
           sock.bind(('127.0.0.1', LOCK_PORT))
           sock.listen(1)
           return False
       except socket.error:
           return True
   ```

2. Функция для завершения других экземпляров бота:
   ```python
   def kill_other_bot_instances():
       current_pid = os.getpid()
       for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
           # Ищем другие процессы Python, запущенные с main.py
           # И пытаемся их завершить
   ```

3. Перемещение удаления webhook перед проверкой соединения с Telegram API, чтобы гарантировать очистку перед запуском поллинга.

4. Добавление паузы после обнаружения других экземпляров, чтобы дать им время завершиться перед запуском текущего экземпляра.

### Как проверить
После деплоя этих изменений на Railway в логах не должны появляться ошибки `TelegramConflictError`, и бот должен стабильно работать даже при перезапуске контейнера.

## Исправление ошибки импорта psutil

### Проблема
При деплое на Railway возникала ошибка импорта библиотеки psutil, что приводило к сбою при запуске бота:
```
ОШИБКА: import psutil
2025-05-22 12:58:37,062 - [RESTART] - ERROR - Бот завершился с кодом 1
```

### Решение
Реализованы следующие исправления:

1. Добавлена защитная обработка импорта psutil в `main.py` и `restart_bot.py`:
   ```python
   try:
       import psutil
       PSUTIL_AVAILABLE = True
       print("Библиотека psutil успешно импортирована")
   except ImportError:
       PSUTIL_AVAILABLE = False
       print("ВНИМАНИЕ: Библиотека psutil не установлена, некоторые функции будут недоступны")
   ```

2. Добавлена условная логика для работы без psutil:
   ```python
   def kill_other_bot_instances():
       if not PSUTIL_AVAILABLE:
           logger.warning("Библиотека psutil не доступна, невозможно завершить другие экземпляры бота")
           print("ПРЕДУПРЕЖДЕНИЕ: Невозможно завершить другие экземпляры бота (psutil не установлен)")
           return
       # ... остальной код ...
   ```

3. Модифицирован Dockerfile для гарантированной установки psutil:
   - Добавлен пакет `procps` для поддержки системных вызовов psutil
   - Принудительная переустановка psutil: `pip install --no-cache-dir --force-reinstall psutil==5.9.5`
   - Добавлена проверка импорта psutil при сборке: `RUN python -c "import psutil; print('psutil успешно установлен...')`

4. Добавлена проверка окружения в `restart_bot.py` перед запуском бота:
   - Проверка наличия зависимостей (aiogram)
   - Проверка существования файла бота
   - Вывод информации о версиях и окружении

### Как проверить
После деплоя этих изменений на Railway:
1. В логах не должны появляться ошибки импорта psutil
2. В начале логов должно быть видно сообщение о результате импорта psutil (успешно или нет)
3. Бот должен запускаться даже при отсутствии psutil, хотя функция обнаружения и завершения других экземпляров в этом случае будет отключена 

# Журнал улучшений и исправлений Ona 2.0

## 23.05.2025

### Добавлена функциональность интеллектуального анализа профиля

- Создан новый сервис `profile_analysis.py` в директории `services/` с функциями:
  - `analyze_profile()` - анализирует профиль пользователя и отвечает на его вопросы о личности
  - `get_profile_insights()` - получает структурированные инсайты о профиле (сильные стороны, зоны роста, рекомендации)
- Обновлен `conversation_handler.py` для обработки вопросов о профиле
- Добавлен механизм распознавания вопросов о профиле на основе ключевых фраз
- Интегрирован OpenAI API для глубокого анализа психологического профиля

### Исправлена функция подсчета ответов в тесте типирования личности

- Улучшена функция `get_personality_type_from_answers` в файле `questions.py`
- Исправлен алгоритм подсчета ответов для корректного определения типа личности 
- Улучшен формат вывода статистики профиля с графическим отображением процентов и эмодзи

### Добавлена система персонализированных советов

- Добавлена кнопка "Советы" в главное меню
- Реализованы обработчики для команды `/advice` и кнопки "Советы"
- Создана функция `get_personalized_advice` для генерации советов на основе типа личности
- Добавлены наборы советов для каждого из четырех типов личности
- Интегрирована кнопка "Получить совет" в интерфейс пользователя

### Улучшена обработка ошибок TTS при генерации медитаций

- Добавлена проверка превышения квоты API ElevenLabs
- Добавлена корректная обработка ошибок в `generate_audio` в `services/tts.py`
- Реализована передача текста медитации пользователю при невозможности сгенерировать аудио
- Добавлены информативные сообщения при различных сценариях ошибок

### Общие улучшения

- Обновлены зависимости в `requirements.txt`
- Улучшена навигация между различными функциями бота
- Добавлены кнопки для возврата в главное меню
- Улучшена система логирования для отслеживания активности пользователя
- Обновлена справка и документация по командам бота 